# User-Specific Lessons Implementation

## Overview

AI-generated lessons are now stored per-user, so each user sees only their own generated lessons, not lessons generated by other users.

## Changes Made

### Backend Changes

1. **`ai-backend/src/routes/ai-lessons.ts`**
   - Changed lesson storage from updating the module to storing in `userLessons/{userId}/modules/{moduleId}/lessons`
   - Lessons are marked with `userGenerated: true` flag
   - Each lesson gets a `createdAt` timestamp

2. **`ai-backend/src/routes/user-lessons.ts`** (NEW)
   - `GET /api/user-lessons/:userId` - Get all user-specific lessons
   - `GET /api/user-lessons/:userId/:moduleId` - Get user lessons for a specific module
   - Handles Firestore Timestamp conversion to ISO strings

3. **`ai-backend/api/index.ts`**
   - Added user-lessons route to the API

### Frontend Changes

1. **`src/contexts/LearningContext.tsx`**
   - Added `fetchUserLessons()` function to fetch user-specific lessons
   - Updated `fetchModulesFromBackend()` to accept and merge user lessons
   - User lessons are merged with module lessons when displaying

2. **`src/components/LearningHub.tsx`**
   - Already reloads modules after requesting new lessons (which triggers fetch of user lessons)

## Data Structure

### Firestore Structure

```
userLessons/{userId}
  ├── userId: string
  ├── modules: {
  │     {moduleId}: {
  │       lessons: GeneratedLesson[]
  │       lastUpdated: Timestamp
  │     }
  │   }
  └── updatedAt: Timestamp
```

### GeneratedLesson Structure

```typescript
{
  id: string
  title: string
  content: string
  xpReward: number
  quiz: GeneratedQuiz[]
  hasAudio?: boolean
  accessLevels?: ('free' | 'basic' | 'standard' | 'premium')[]
  createdAt: Timestamp
  userGenerated: true
}
```

## Flow

1. **User Requests More Lessons:**
   - Frontend calls `POST /api/ai-lessons/generate`
   - Backend generates lessons using OpenAI
   - Lessons are stored in `userLessons/{userId}/modules/{moduleId}/lessons`
   - Response returned to frontend

2. **Frontend Displays Lessons:**
   - LearningContext fetches modules from `GET /api/tutor-admin/modules/level/{tier}`
   - LearningContext fetches user lessons from `GET /api/user-lessons/{userId}`
   - User lessons are merged with module lessons
   - Combined lessons are displayed to the user

3. **Lesson Uniqueness:**
   - Each lesson has a unique ID
   - User lessons are appended to module lessons
   - No duplicates are created (user lessons are separate)

## Security

- Users can only access their own lessons (Firestore rules should enforce this)
- User lessons are stored separately from shared module lessons
- User lessons are only visible to the user who requested them

## Testing

1. **Test User-Specific Storage:**
   - User A requests lessons for Module 1
   - User B requests lessons for Module 1
   - Verify User A only sees their lessons
   - Verify User B only sees their lessons

2. **Test Lesson Merging:**
   - Verify user lessons appear after module lessons
   - Verify lesson count includes both module and user lessons
   - Verify expand/collapse works with merged lessons

3. **Test Persistence:**
   - Request lessons
   - Close and reopen Learning Hub
   - Verify user lessons still appear

## Firestore Rules

Make sure Firestore rules allow users to read their own userLessons:

```javascript
match /userLessons/{userId} {
  allow read: if request.auth != null && request.auth.uid == userId;
  allow write: if request.auth != null && request.auth.uid == userId;
}
```

## API Endpoints

### Generate User Lessons
```
POST /api/ai-lessons/generate
Body: {
  userId: string
  moduleId: string
  moduleName: string
  completedLessons: string[]
  tier: 'free' | 'basic' | 'standard' | 'premium'
  numberOfLessons?: number
}
Response: {
  success: true
  lessons: GeneratedLesson[]
  totalLessons: number
  message: string
}
```

### Get User Lessons (All Modules)
```
GET /api/user-lessons/:userId
Response: {
  modules: {
    [moduleId]: {
      lessons: GeneratedLesson[]
      lastUpdated: string
    }
  }
}
```

### Get User Lessons (Single Module)
```
GET /api/user-lessons/:userId/:moduleId
Response: {
  lessons: GeneratedLesson[]
}
```

## Notes

- User lessons are stored indefinitely (no automatic cleanup)
- User lessons persist across sessions
- User lessons are included in lesson count and progress tracking
- User lessons follow the same access control as module lessons

